@model Tuple<IEnumerable<E.m.a.r.t.Models.Fotografias>, E.m.a.r.t.Models.Colecao>
@*// Esta view utiliza uma tupla como modelo contendo:
// - Uma coleção de objetos do tipo "Fotografias" (lista de fotos existentes)
// - Um objeto do tipo "Colecao" (utilizado para criar uma nova coleção)*@

@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@*// Permite o uso de Tag Helpers do ASP.NET, como asp-for e asp-action*@

@{
    Layout = "_Layout"; // Define que esta view utilizará o layout principal da aplicação
    var listaFotos = Model.Item1; // Extrai a lista de fotografias da tupla
    var novaColecao = Model.Item2; // Extrai o objeto de nova coleção da tupla
    var novaFoto = ViewBag.NovaFoto as E.m.a.r.t.Models.Fotografias; // Fotografia usada para preenchimento do formulário de upload
}

<h2>Nova Fotografia</h2>

@if (!ViewData.ModelState.IsValid)
{
    // Bloco de exibição de erros de validação
    <div class="alert alert-danger">
        <ul>
            @foreach (var state in ViewData.ModelState)
            {
                foreach (var error in state.Value.Errors)
                {
                    <li>@state.Key: @error.ErrorMessage</li>
                }
            }
        </ul>
    </div>
}

<!-- Formulário de upload de nova fotografia -->
<form asp-action="Upload" method="post" enctype="multipart/form-data" class="mb-4">
    <div class="form-group">
        <label asp-for="@novaFoto.Titulo"></label>
        <input asp-for="@novaFoto.Titulo" class="form-control" />
        <span asp-validation-for="@novaFoto.Titulo" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="@novaFoto.Descricao"></label>
        <input asp-for="@novaFoto.Descricao" class="form-control" />
        <span asp-validation-for="@novaFoto.Descricao" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="@novaFoto.Data"></label>
        <input asp-for="@novaFoto.Data" type="date" class="form-control" />
        <span asp-validation-for="@novaFoto.Data" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="@novaFoto.Preco"></label>
        <input asp-for="@novaFoto.Preco" class="form-control" type="text" />
        <span asp-validation-for="@novaFoto.Preco" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label for="imagem">Fotografia (ficheiro)</label>
        <input type="file" name="imagem" accept="image/*" class="form-control" />
    </div>

    <div class="form-group">
        <label asp-for="@novaFoto.ColecaoFK">Coleção</label>
        <select asp-for="@novaFoto.ColecaoFK" class="form-control"
                asp-items="@(new SelectList(ViewBag.ListaColecoes, "Id", "Nome"))">
            <option value="">-- Sem coleção --</option>
        </select>
        <span asp-validation-for="@novaFoto.ColecaoFK" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-success mt-2">Adicionar</button>
</form>

<hr />
<h2>Nova Coleção</h2>
<!-- Formulário para criação de nova coleção -->
<form asp-action="CriarColecao" method="post" class="mb-4">
    <div class="form-group">
        <label asp-for="@novaColecao.Nome">Nome da Coleção</label>
        <input asp-for="@novaColecao.Nome" class="form-control" />
        <span asp-validation-for="@novaColecao.Nome" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label asp-for="@novaColecao.Descricao">Descrição</label>
        <textarea asp-for="@novaColecao.Descricao" class="form-control"></textarea>
        <span asp-validation-for="@novaColecao.Descricao" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-primary">Criar Coleção</button>
</form>

<hr />
<h2>Lista de Coleções</h2>
<!-- Tabela com a lista de coleções disponíveis, com formulários embutidos para editar e eliminar -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Nome</th>
            <th>Descrição</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var colecao in ViewBag.ListaColecoes as List<E.m.a.r.t.Models.Colecao>)
        {
            <tr>
                <!-- Formulário de edição de coleção -->
                <form asp-action="EditarColecao" method="post" class="d-flex align-items-center">
                    <input type="hidden" name="Id" value="@colecao.Id" />

                <td>
                    <input type="text" name="Nome" value="@colecao.Nome" class="form-control" />
                </td>
                <td>
                    <input type="text" name="Descricao" value="@colecao.Descricao" class="form-control" />
                </td>
                <td class="d-flex gap-1">
                    <button type="submit" class="btn btn-warning btn-sm">Guardar</button>
                </td>
                </form>

                <!-- Botão de eliminar coleção -->
                <td>
                    <form asp-action="EliminarColecao" method="post" class="d-inline" onsubmit="return confirm('Eliminar esta coleção? As fotografias associadas ficarão sem coleção.')">
                        <input type="hidden" name="id" value="@colecao.Id" />
                        <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

<h2>Lista de Fotografias</h2>
<!-- Tabela com a lista de fotografias existentes com campos editáveis -->
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Título</th>
            <th>Coleção</th>
            <th>Descrição</th>
            <th>Data</th>
            <th>Preço</th>
            <th>Imagem</th>
            <th>Ações</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var foto in Model.Item1)
        {
            <tr>
                <!-- Formulário de edição de fotografia -->
                <form asp-action="Edit" method="post" class="d-flex align-items-center">
                    <input type="hidden" name="Id" value="@foto.Id" />
                    <input type="hidden" name="Ficheiro" value="@foto.Ficheiro" />

                <td><input type="text" name="Titulo" value="@foto.Titulo" class="form-control" /></td>

                <td>
                    <select name="ColecaoFK" class="form-control"
                            asp-items="@(new SelectList(ViewBag.ListaColecoes, "Id", "Nome", foto.ColecaoFK))">
                        <option value="">-- Sem coleção --</option>
                    </select>
                </td>

                <td><input type="text" name="Descricao" value="@foto.Descricao" class="form-control" /></td>
                <td><input type="date" name="Data" value="@foto.Data.ToString("yyyy-MM-dd")" class="form-control" /></td>
                <td><input type="text" name="Preco" value="@foto.Preco.ToString("0.00")" class="form-control" /></td>

                <td>
                        @if (!string.IsNullOrEmpty(foto.Ficheiro))
                        {
                            // Exibe a miniatura da imagem se o ficheiro estiver definido
                        <img src="~/imagens/@foto.Ficheiro" alt="@foto.Titulo" width="100" />
                        }
                </td>

                <td class="d-flex gap-1">
                    <button type="submit" class="btn btn-warning btn-sm">Guardar</button>
                </td>
                </form>

                <!-- Botão de eliminar fotografia -->
                <td>
                    <form asp-action="Delete" method="post">
                        <input type="hidden" name="id" value="@foto.Id" />
                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Eliminar esta fotografia?');">Eliminar</button>
                    </form>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
        // Inclusão de scripts de validação de formulário client-side
    <partial name="_ValidationScriptsPartial" />
}